!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);var i={};s.r(i),s.d(i,"RectSource",(function(){return S})),s.d(i,"Anchor",(function(){return v}));var r={};function h(t){return function(e){return Object.prototype.toString.call(e)==="[object "+t+"]"}}s.r(r),s.d(r,"SVGRender",(function(){return j})),s.d(r,"CanvasRender",(function(){return j})),s.d(r,"RenderBase",(function(){return l}));const n={isFunction:h("Function"),isArray:h("Array"),uuid:(t=10)=>{let e=[];for(var s=0;s<t;s++)e.push(Math.ceil(57*Math.random())+65);return String.fromCharCode.apply(String,e)},counterFactory:(t=0,e=1)=>function(){return t+e++}},o=(t,e,s)=>{t.addEventListener(e,s)},a=(t,e,s)=>{t.removeEventListener(e,s)};class c{constructor(){this.listener={},this.bridgeListener={}}on(t,e,s){return(this.listener[t]||(this.listener[t]=[])).push({name:t,fn:e,context:s}),this}once(t,e,s){var i=this.listener[t]||(this.listener[t]=[]),r=this;return i.push({name:t,fn:function i(){var h=e.apply(s||this,arguments);return r.off(t,i),h},context:s}),this}off(t,e,s){if(this.bridgeListener[t]=[],t)if(e)for(var i=this.listener[t]||(this.listener[t]=[]),r=i.length-1;r>=0;r--){var h=i[r];h.fn!==e&&h.context!==s||i.splice(r,1)}else this.listener[t]=[];else this.listener={};return this}emit(t){for(var e=this.listener[t]||(this.listener[t]=[]),s=this.bridgeListener[t]||[],i=arguments.length,r=new Array(i>1?i-1:0),h=1;h<i;h++)r[h-1]=arguments[h];for(var n=0,o=e.length;n<o;n++){var a=e[n],c=a.fn,d=a.context;c.apply(d,r)}for(o=s.length,n=0;n<o;n++){var l=s[n];l.emmiter.emit.apply(l.emmiter,[l.name].concat(r))}return this}bridge(t,e,s){return s||(s=t),(this.bridgeListener[t]||(this.bridgeListener[t]=[])).push({name:s,emmiter:e}),this}}const d=(t,e="")=>t?t+e:"100%";class l{constructor(t){this.shapes=[],this.$contaner=this.createElemet(t),this.$contaner.style.cssText=(t=>{let e=[];return e.push("width:"+d(t.width)),e.push("height:"+d(t.height)),e.push("position:relative"),e.join(";")})(t),t.el&&t.el.appendChild(this.$contaner),this.shapes=[]}add(t){return this.has()||this.shapes.push(t),t}remove(t){let e=this.shapes.indexOf(t);this.shapes.splice(e,1)}has(t){return this.shapes.indexOf(t)>-1}createElemet(){return document.createElement("div")}mount(t){this.$contaner&&t.appendChild(this.$contaner)}render(){}}const u=(t,e="")=>t?t+e:"100%",p=t=>{switch(t[0]){case"M":case"m":return t[0]+" "+t.slice(1).join(",");case"a":return[t[0],t.slice(1,3),t[3],t.slice(4,6),t.slice(6)].join(" ");default:return t.join(" ")}},g=(t,e,s)=>{t["__"+e]!==s&&(t.setAttribute(e,s),t["__"+e]=s)},f=function(t){let{shape:e,style:s}=t,i=(t=>{let e=document.createElementNS("http://www.w3.org/2000/svg","svg");return e.style.position="absolute",e})(),r=document.createElementNS("http://www.w3.org/2000/svg","path");return i.update=function(t){let e=t.shape;((t,e)=>{var s,i,r;g(t,"width",u(e.width,"")),g(t,"height",u(e.height,"")),s=t,i="transform",r=`translate(${u(e.x,"px")}, ${u(e.y,"px")})`,s.style["__"+i]!==r&&(s.style[i]=r,s.style["__"+i]=r)})(i,e),g(r,"width",u(e.width,"")),g(r,"height",u(e.height,"")),g(r,"d",t.getPath().map(p).join(" ")),s.strokeWidth&&g(r,"stroke-width",s.strokeWidth),s.strokeColor&&g(r,"stroke",s.strokeColor),g(r,"fill",s.fillColor||"none")},i.update(t),i.appendChild(r),i};class y extends l{constructor(t){super(t)}bindEvent(t){let e=t;return["click","mousedown","mouseup","mousemove","mouseout","mouseenter","mouseover"].forEach(s=>{o(t.el,s,e.emit.bind(e,s))}),e.on("update",this.render.bind(this)),t}add(t){return t.el||(t.el=function(t){switch(t.type){case"circle":case"rect":default:return f(t)}}(t),t.dirty(),this.bindEvent(t)),super.add(t)}remove(t){let e=this.shapes.indexOf(t);var s;this.shapes.splice(e,1),t.el&&((s=t.el).parentElement&&s.parentElement.removeChild(s),t.el=null)}render(){for(let t=0,e=this.shapes.length;t<e;t++){let e=this.shapes[t];e.el.parentElement||this.$contaner.appendChild(e.el),e.__dirty&&e.el.update(e),e.__dirty=!1}}}class _ extends c{constructor(t){super(),this.x=t.x||0,this.y=t.y||0,this.anchor=[],this.id=t.id||n.uuid(),delete t.x,delete t.y}copy(){return this.constructor(this.config)}destory(){this.__render&&this.shape&&(this.__render.remove(this.shape),this.shape.off()),this.off()}}class m extends c{constructor(t){super(),this.__dirty=!0,this.el=null,this.id=n.uuid(),this.path=[],this.type=t.type,this.shape=t.shape,this.style=t.style||{}}setPath(t){this.path=t}setShape(t,e){"string"==typeof t?this.shape[t]=e:Object.assign(this.shape,t),this.dirty()}setStyle(t,e){"string"==typeof t?this.style[t]=e:Object.assign(this.style,t),this.dirty()}getRectPath(){let t=this.shape,e=[];return e.push(["M",0,0]),e.push(["L",t.width,0]),e.push(["L",t.width,t.height]),e.push(["L",0,t.height]),e.push(["Z"]),e}getCircle(){let{shape:t,style:e}=this,s=t.width-2*e.strokeWidth,i=s/2,r=[];return r.push(["M",t.width/2,t.height/2]),r.push(["m",-i,0]),r.push(["a",i,i,0,1,0,s,0]),r.push(["a",i,i,0,1,0,-s,0]),r.push(["Z"]),r}getPolyline(){let{shape:t}=this,e=t.paths.map(([t,e])=>["L",t,e]);return e[0][0]="M",e}getPath(){switch(this.type){case"rect":return this.getRectPath();case"circle":return this.getCircle();case"polyline":return this.getPolyline()}}dirty(t){this.__dirty=!0,t||this.emit("update")}mount(t){t&&(this.el=t)}destroy(){this.off()}}class b extends _{constructor(t,e,s){super(s),this.target=e,this.source=t,this.target.addConnector(this),this.source.addConnector(this)}initEvent(){this.__refresh=this.refresh.bind(this),this.target.shape.on("update",this.__refresh),this.source.shape.on("update",this.__refresh)}updateAnchor(t,e){e&&e.off("update",this.__refresh),t.on("update",this.__refresh),this.refresh()}setSource(t){let e=this.source;this.source=t,this.updateAnchor(t,e)}setTarget(t){let e=this.target;this.target=t,this.updateAnchor(t,e)}render(){this.__render&&(this.shape||(this.shape=this.__render.add(this.toShape()),this.initEvent()))}getShape(){let t=this.target,e=this.source,s=e.getCenter(),i=t.getCenter(),[r,h]=[Math.min(t.x,e.x),Math.min(t.y,e.y)],[n,o]=[Math.max(t.x,e.x),Math.max(t.y,e.y)];return{x:r,y:h,width:n-r+s[0],height:o-h+s[1],paths:[[e.x-r+s[0],e.y-h+s[1]],[t.x-r+i[0],t.y-h+i[1]]]}}refresh(){this.shape&&this.shape.setShape(this.getShape())}toShape(){return this.shape||new m({type:"polyline",shape:this.getShape(),style:{strokeWidth:2,strokeColor:"red"}})}}class w{constructor(t){this.render=t.render||new y(t),this.render.mount(t.el),this.sourceList=[],this.anchorList=[],this.connectorList=[]}_pack(t){return t.__render=this.render,t.root=this,t}add(t){this.sourceList.push(this._pack(t)),this.anchorList.push(...t.anchor.map(this._pack.bind(this))),this.refresh()}getSource(t){return t}getConnector(t){return t}getAnchor(t){return this.anchorList.filter(e=>e.id===t)[0]}connect(t,e){e="string"==typeof e?this.getAnchor(e):e,t="string"==typeof t?this.getAnchor(t):t;let s=new b(t,e,{});return s.__render=this.render,this.connectorList.push(s),this.refresh(),s}refresh(){for(let t=0,e=this.sourceList.length;t<e;t++){this.sourceList[t].render()}for(let t=0,e=this.connectorList.length;t<e;t++)this.connectorList[t].render();this.render.render()}reRender(){this.render.refresh()}}const x=n.counterFactory(3e3);class v extends _{constructor(t,e){super(t),this.source=e,this.type=t.type,this.config=t,this.connectorList=[]}copy(){return new v({...this.config,x:this.x,y:this.y})}setBasePosition(t,e){let[s,i]=this.config.position;this.x=t+s,this.y=e+i,this.shape.setShape({x:this.x,y:this.y})}addConnector(t){this.connectorList.push(t)}initEvent(){let t=!1,e=null,s=null,[i,r]=[0,0],h=t=>{let s=i-(t.clientX||t.pageX),h=r-(t.clientY||t.pageY);e.setBasePosition(this.x-s,this.y-h)},n=t=>{let i=t.target.__targetAnchor;i&&(s.setTarget(i),this.root.connect(this,i),t.target.__targetAnchor=null),s.destory(),e.destory(),a(document.body,"mousemove",h),a(document.body,"mouseup",n)};this.shape.on("mousedown",t=>{t.stopPropagation(),e=new v({type:"circle",x:this.x,y:this.y,position:[0,0],width:10,height:10}),t.target.__anchor=this,s=new b(this,e,{}),e.__render=this.__render,s.__render=this.__render,e.render(),s.render(),i=t.clientX||t.pageX,r=t.clientY||t.pageY,o(document.body,"mousemove",h),o(document.body,"mouseup",n)}),this.shape.on("mouseover",e=>{e.target.__anchor&&e.target.__anchor.source===this.source||(t=!0)}),this.shape.on("mouseup",e=>{t&&(e.target.__targetAnchor=this)}),this.shape.on("mouseout",e=>{t=!1})}getCenter(){return[this.config.width/2,this.config.height/2]}toShape(){return this.shape||new m({type:this.type,shape:{x:this.x,y:this.y,width:this.config.width,height:this.config.height},style:{zIndex:x(),strokeWidth:this.config.borderWidth||0,strokeColor:this.config.borderColor||"black",fillColor:this.config.backgroundColor||"white",raduis:this.config.borderRaduis||0}})}render(){this.__render&&(this.shape||(this.shape=this.__render.add(this.toShape()),this.initEvent()))}}const C={type:"circle",width:20,height:20,borderColor:"blue",borderWidth:"1",backgroundColor:"red"};class S extends _{constructor(t){super(t),this.anchor=[],this.config=t,this.initAnchor(t),this.refresh()}copy(){let t=new S({...this.config,x:this.x,y:this.y});return t.anchor=this.anchor.map(e=>{let s=e.copy();return s.source=t,s}),t}addAnchor(t){t.__render=this.__render,this.anchor.push(t)}initAnchor(t){let e=t.anchor;delete t.anchor,e&&(e=((t,e,s)=>(t=n.isArray(t)?t:[t]).map(t=>((t="string"==typeof t?{position:t}:t).shape=Object.assign({},C,t.shape||{}),t.__position=t.position,t.position=((t,e,s,i)=>{let r=e.width/2,h=e.height/2;switch(t){case"top":return[s/2-r,-h];case"right":return[s-r,i/2-h];case"bottom":return[s/2-r,i-h];case"left":return[-r,i/2-h]}})(t.position,t.shape,e,s),t)))(e,this.config.width,this.config.height),e.forEach(t=>{let[e,s]=t.position;t.shape.x=e+this.x,t.shape.y=s+this.y,t.shape.position=t.position,t.shape.id=t.id,t.shape.__position=t.__position,this.addAnchor(new v(t.shape,this))}))}getAnchorPoint(t){let{shape:{shape:e}}=t,s=[e.width/2,e.height/2];switch(t.config.__position){case"right":{let t=[s,[e.width/2+10,e.height/2]];return{start:t[1],paths:t}}case"bottom":{let t=[s,[e.width/2,e.height/2+10]];return{start:t[1],paths:t}}default:return{start:[0,0],paths:[[0,0]]}}}refresh(){this.__render&&this.__render.render()}initEvent(){let[t,e,s,i]=[0,0,this.x,this.y];const r=r=>{let h=t-(r.clientX||r.pageX),n=e-(r.clientY||r.pageY);this.x=s-h,this.y=i-n,this.anchor.map(t=>{t.setBasePosition(this.x,this.y)}),this.shape.setShape({x:this.x,y:this.y})},h=t=>{a(document.body,"mousemove",r),a(document.body,"mouseup",h)};this.shape.on("mousedown",n=>{t=n.clientX||n.pageX,e=n.clientY||n.pageY,s=this.x,i=this.y,console.log(t,e),o(document.body,"mousemove",r),o(document.body,"mouseup",h)})}render(){if(this.__render){this.shape||(this.shape=this.__render.add(this.toShape()),this.initEvent());for(let t=0,e=this.anchor.length;t<e;t++){this.anchor[t].render()}}}toShape(){return this.shape||new m({type:"rect",shape:{x:this.x,y:this.y,width:this.config.width,height:this.config.height},style:{strokeWidth:this.config.borderWidth||0,strokeColor:this.config.borderColor||"black",fillColor:this.config.backgroundColor||"white",raduis:this.config.borderRaduis||0}})}}const k=(t,e="")=>t?t+e:"100%",E=(t,e,s)=>t["__"+e]!==s&&(t.setAttribute(e,s),t["__"+e]=s,!0),L=(t,e,s)=>t.style["__"+e]!==s&&(t.style[e]=s,t.style["__"+e]=s,!0),P=(t,e,s,i)=>!(t["__"+e]===s&&!i)&&(t[e]=s,t["__"+e]=s,!0),A={M(t,e){this.moveTo(t,e),A.cache.call(this,t,e)},m(t,e){t+=this.__x||0,e+=this.__y||0,A.M.call(this,t,e)},a(t,e,s,i,r,h,n){this.__x,this.__y,this.ellipse&&this.ellipse(10,10,t,e,0,s/180*Math.PI,Math.PI/180,!r)},L(t,e){this.lineTo(t,e),A.cache.call(this,t,e)},Z(){this.closePath(),this.fill()},cache(t,e){this.__x=t,this.__y=e}},M=()=>{let t=document.createElement("canvas"),e=t.getContext("2d");return t.update=s=>{let{shape:i,style:r}=s;e.clearRect(0,0,i.width,i.height);let h=E(t,"width",i.width+20),n=E(t,"height",i.height+20);L(t,"width",k(i.width+20,"")),L(t,"height",k(i.height+20,"")),r.strokeWidth&&P(e,"lineWidth",r.strokeWidth,h||n),r.strokeColor&&P(e,"strokeStyle",r.strokeColor,h||n),P(e,"fillStyle",r.fillColor||"none"),((t,e)=>{let s=e.getPath();for(let e=0,i=s.length;e<i;e++){let i=s[e][0];A[i].apply(t,s[e].slice(1))}t.stroke()})(e,s)},t.__ctx=e,t};class j extends l{constructor(t){super(t),this.initEvent()}getEventShapes(t){let e=[];for(let s=0,i=this.shapes.length;s<i;s++){let i=this.shapes[s];i.el.__ctx.isPointInPath(t.offsetX-i.shape.x,t.offsetY-i.shape.y)&&e.push(i)}return e.reverse()}_handleEvent(t,e){let s=this.getEventShapes(e),i=e.stopPropagation||function(){},r=!1;e.stopPropagation=function(){i.apply(e,arguments),r=!0};for(let i=0,h=s.length;i<h&&(s[i].emit(t,e),!r);i++);}initEvent(){["click","mousedown","mouseup","mousemove","mouseout","mouseenter","mouseover"].forEach(t=>{o(this.$contaner,t,this._handleEvent.bind(this,t))})}createElemet(t){let e=document.createElement("canvas");return e.width=t.width,e.height=t.height,this.ctx=e.getContext("2d"),e}add(t){return t.el||(t.el=M(),t.dirty(),t.on("update",this.render.bind(this))),super.add(t)}remove(t){super.remove(t),t.el&&this.render()}render(){this.$contaner.width=this.$contaner.width;for(let t=0,e=this.shapes.length;t<e;t++){let e=this.shapes[t];e.__dirty&&e.el.update(e),this.ctx.drawImage(e.el,e.shape.x,e.shape.y),e.__dirty=!1}}}var R={init:function(t){return new w(t)},...i,...r};window.onload=function(){let t=R.init({el:document.getElementById("container_svg")});window.plumbInst=t;let e=new R.RectSource({width:100,height:100,x:100,y:100,borderColor:"red",borderWidth:2,backgroundColor:"rgba(0,0,0,0.1)",borderRaduis:5,anchor:["top",{position:"right",id:"source-right"}]});console.log("source",e),t.add(e);let s=new R.RectSource({width:100,height:100,x:300,y:300,borderColor:"red",borderWidth:2,backgroundColor:"rgba(0,0,0,0.1)",borderRaduis:5,anchor:[{position:"left"},{position:"bottom",id:"target-bottom",shape:{type:"rect",borderColor:"blue",borderWidth:"1",backgroundColor:"blue"}}]});t.add(s),t.connect("source-right","target-bottom");let i=R.init({el:document.getElementById("container_canvas"),render:new R.CanvasRender({width:800,height:800})});i.add(e.copy()),i.add(s.copy()),i.connect("source-right","target-bottom"),window.plumbCanvas=i}}]);